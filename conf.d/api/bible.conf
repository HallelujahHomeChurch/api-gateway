# ============================================================================
# Bible API Routes (via Dapr)
# ============================================================================
# Pattern: /api/bible/v*
# Backend: bible-api service via Dapr sidecar
# Dapr app-id: bible-api
# ============================================================================

location /api/bible/ {
    # include /usr/local/openresty/nginx/conf/conf.d/common/cors.conf;

    # Bible versions endpoint - Optional auth (authenticate if token present)
    location ~ ^/api/bible/v[0-9]+/versions {
        set $auth_mode "optional";
        limit_req zone=api_limit burst=50 nodelay;
        proxy_pass $bible_api_base$uri$is_args$args;
    }

    # Version content streaming endpoint - Optional auth
    location ~ ^/api/bible/v[0-9]+/version/[0-9]+$ {
        set $auth_mode "optional";
        limit_req zone=api_limit burst=10 nodelay;
        include /usr/local/openresty/nginx/conf/conf.d/common/streaming.conf;
        proxy_pass $bible_api_base$uri$is_args$args;
    }

    # Bible content search endpoint - Optional auth
    location ~ ^/api/bible/v[0-9]+/search {
        set $auth_mode "optional";
        limit_req zone=api_limit burst=10 nodelay;
        proxy_pass $bible_api_base$uri$is_args$args;
    }

    # Bible favorites verse endpoint - Required auth (must have valid token)
    location ~ ^/api/bible/v[0-9]+/favorites {
        set $auth_mode "required";
        limit_req zone=api_limit burst=10 nodelay;
        proxy_pass $bible_api_base$uri$is_args$args;
    }
}

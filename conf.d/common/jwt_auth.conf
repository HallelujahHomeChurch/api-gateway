# ============================================================================
# JWT Authentication Configuration
# ============================================================================
# Purpose: Common JWT authentication settings
# Usage: This file is included in default.conf
#        Set $auth_mode in location blocks to change authentication mode:
#        - "none": No authentication required (default, if not set)
#        - "optional": Authenticate if token present, otherwise allow
#        - "required": Authentication required, returns 401 if invalid
# ============================================================================

# Load JWT authentication module
access_by_lua_block {
    -- Get auth mode from location variable (set in location block)
    local auth_mode = ngx.var.auth_mode or "none"
    
    -- Skip authentication if mode is "none"
    if auth_mode == "none" then
        return
    end
    
    local jwt_auth = require "jwt_auth"
    
    -- Perform authentication
    local success, err = jwt_auth.authenticate(auth_mode)
    
    if not success then
        ngx.status = 401
        ngx.header.content_type = "application/json"
        ngx.say('{"error":"Unauthorized: ' .. (err or "Authentication failed") .. '"}')
        ngx.exit(401)
    end
}


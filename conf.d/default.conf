# ============================================================================
# API Gateway Server Configuration
# ============================================================================
# Purpose: Main gateway server routing requests to backend services
# Port: 10000
# Domain: www.alive.org.tw
# ============================================================================

server {
    listen 10000 reuseport;
    server_name www.alive.org.tw;

    # Security: Limit concurrent connections per IP
    limit_conn addr 50;

    # ========================================================================
    # Include Common Configurations
    # ========================================================================
    include /etc/nginx/conf.d/common/proxy.conf;     # Common proxy settings
    include /etc/nginx/conf.d/common/error.conf;     # Error handling pages
    include /etc/nginx/conf.d/common/health.conf;    # Health check endpoints

    # ========================================================================
    # Location: Bible API Routes
    # ========================================================================
    # Pattern: /api/bible/v1, /api/bible/v2, etc.
    # Backend: bible-api service
    # ========================================================================
    location ~ ^/api/bible/v[0-9]+ {
        limit_req zone=api_limit burst=50 nodelay;
        
        proxy_pass https://bible-api.internal.gentleriver-81abd7bc.eastasia.azurecontainerapps.io;
        proxy_ssl_name bible-api.internal.gentleriver-81abd7bc.eastasia.azurecontainerapps.io;
        proxy_set_header Host bible-api.internal.gentleriver-81abd7bc.eastasia.azurecontainerapps.io;
    }

    # ========================================================================
    # Location: Default Route
    # ========================================================================
    # Pattern: / (all other requests)
    # Backend: alive-app service
    # ========================================================================
    location / {
        limit_req zone=api_limit burst=50 nodelay;

        proxy_pass https://alive-app.internal.gentleriver-81abd7bc.eastasia.azurecontainerapps.io;
        proxy_ssl_name alive-app.internal.gentleriver-81abd7bc.eastasia.azurecontainerapps.io;
        proxy_set_header Host alive-app.internal.gentleriver-81abd7bc.eastasia.azurecontainerapps.io;
    }
}


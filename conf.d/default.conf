# ============================================================================
# API Gateway Server Configuration
# ============================================================================
# Purpose: Main gateway server routing requests to backend services via Dapr
# Port: 10000
# Domain: www.alive.org.tw
# ============================================================================

server {
    listen 10000 reuseport;
    server_name www.alive.org.tw;

    # Security: Limit concurrent connections per IP
    limit_conn addr 50;

    # ========================================================================
    # Include Common Configurations
    # ========================================================================
    include /etc/nginx/conf.d/common/error.conf;     # Error handling pages
    include /etc/nginx/conf.d/common/health.conf;    # Health check endpoints

    # ========================================================================
    # Location: Bible API Version Content Routes (Streaming via Dapr)
    # ========================================================================
    # Pattern: /api/bible/v*/version/{id}
    # Backend: bible-api service via Dapr sidecar
    # Dapr app-id: bible-api
    # Special: Uses streaming configuration for large content
    # Auth: Basic Authentication required
    # ========================================================================
    location ~ ^/api/bible/v[0-9]+/version/[0-9]+$ {
        limit_req zone=api_limit burst=10 nodelay;  # Lower burst for streaming

        # Basic Authentication
        auth_basic "Bible API Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        include /etc/nginx/conf.d/common/cors.conf;
        include /etc/nginx/conf.d/common/streaming.conf;  # Use streaming config
        proxy_pass http://127.0.0.1:3500/v1.0/invoke/bible-api/method$uri$is_args$args;
    }

    # ========================================================================
    # Location: Bible API Other Routes (via Dapr)
    # ========================================================================
    # Pattern: /api/bible/v1, /api/bible/v2, etc. (except version content)
    # Backend: bible-api service via Dapr sidecar
    # Dapr app-id: bible-api
    # Auth: Basic Authentication required
    # ========================================================================
    location ~ ^/api/bible/v[0-9]+ {
        limit_req zone=api_limit burst=50 nodelay;

        # Basic Authentication
        auth_basic "Bible API Access";
        auth_basic_user_file /etc/nginx/.htpasswd;

        include /etc/nginx/conf.d/common/cors.conf;
        include /etc/nginx/conf.d/common/dapr.conf;
        proxy_pass http://127.0.0.1:3500/v1.0/invoke/bible-api/method$uri$is_args$args;
    }

    # ========================================================================
    # Location: Search API Routes (via Dapr)
    # ========================================================================
    # Pattern: /api/search/v1, /api/search/v2, etc.
    # Backend: search-api service via Dapr sidecar
    # Dapr app-id: search-api
    # ========================================================================
    location ~ ^/api/search/v[0-9]+ {
        limit_req zone=api_limit burst=50 nodelay;

        include /etc/nginx/conf.d/common/cors.conf;
        include /etc/nginx/conf.d/common/dapr.conf;
        proxy_pass http://127.0.0.1:3500/v1.0/invoke/search-api/method$uri$is_args$args;
    }

    # ========================================================================
    # Location: Default Route (via Dapr)
    # ========================================================================
    # Pattern: / (all other requests)
    # Backend: alive-app service via Dapr sidecar
    # Dapr app-id: alive-app
    # ========================================================================
    location / {
        limit_req zone=api_limit burst=50 nodelay;

        include /etc/nginx/conf.d/common/dapr.conf;
        proxy_pass http://127.0.0.1:3500/v1.0/invoke/alive-app/method$uri$is_args$args;
    }
}

